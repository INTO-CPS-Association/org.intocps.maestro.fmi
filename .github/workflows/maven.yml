# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: jnifmuapi

on: [ workflow_dispatch, push, pull_request ]
env:
  JAVA_VERSION: 1.8
  SERVER_ID: snapshots
  PYTHON_VERSION: '3.9.9'



jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ] # ubuntu-latest, , macos-latest
        platform: [ x64 ] #x32, x64 ]
        exclude:
          - os: macos-latest
            platform: x32
    #        config:
    #          - {
    #            name: "Windows Latest MinGW", artifact: "Windows-MinGW.tar.xz",
    #            os: windows-latest,
    #            build_type: "Release", cc: "mingw32-gcc.exe", cxx: "mingw32-c++.exe",
    #            generators: "Unix Makefiles"
    #          }
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: actions/checkout@v2
        with:
          submodules: 'true'

      - name: ubuntu add 32bit compiler
        run: sudo apt-get update && sudo apt-get install gcc-multilib
        if: matrix.platform == 'x32' && matrix.os == 'ubuntu-latest'

      - name: Set up Java x64
        if: matrix.platform == 'x64'
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          architecture: x64

      - name: Set up Java x32
        if: matrix.platform == 'x86'
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          architecture: x32

      - name: Put MSYS2_MinGW64 on PATH for windows
        if: matrix.os == 'windows-latest'
        # there is not yet an environment variable for this path from msys2/setup-msys2
        # We need this to get a gcc 11.2 that is new enough to compile the reference FMU3
        run: echo "C:\msys64/mingw64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Maven download
        run: mvn validate dependency:resolve-plugins -B --quiet
      #      - name: Alter path
      #        run: echo "C:\msys64\mingw32\bin" >> $GITHUB_PATH

      - name: Maven Build x32
        run: mvn -B package --file pom.xml -Pmake32
        if: matrix.platform == 'x32'

      - name: Maven Build x64
        run: mvn -B package --file pom.xml -Pmake
        if: matrix.platform == 'x64'

      - name: artifact
        uses: actions/upload-artifact@v2
        with:
          name: lib
          path: |
            jnifmuapi/target/classes/lib/**/libfmuapi.so
            jnifmuapi/target/classes/lib/**/libfmuapi.dylib
            jnifmuapi/target/classes/lib/**/fmuapi.dll
            jnifmuapi/target/fmus/**/*.so
            jnifmuapi/target/fmus/**/*.dylib
            jnifmuapi/target/fmus/**/*.dll
          retention-days: 1

  #      - name: artifact
  #        if: always() && matrix.os == 'windows-latest'
  #        uses: actions/upload-artifact@v2
  #        with:
  #          name: bblog
  #          path: |
  #
  #            jnifmuapi/target/fmus/*
  #          retention-days: 1

  pack:
    runs-on: ubuntu-latest

    needs: build
    steps:
      - uses: actions/checkout@v2
      - name: Download all workflow run artifacts
        uses: actions/download-artifact@v2
        with:
          name: lib
      #          path: jnifmuapi/target/classes
      - name: Set up Java x64
        if: matrix.platform == 'x64'
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          architecture: x64

      - name: Set up Java x32
        if: matrix.platform == 'x86'
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          architecture: x32

      - name: Maven download
        run: mvn validate dependency:resolve-plugins -B --quiet

      - name: Maven Build Final
        run: mvn -B package --file pom.xml -Dmaven.test.skip=true

      - name: upload jnifmuapi
        uses: actions/upload-artifact@v2
        with:
          name: jnifmuapi
          path: |
            jnifmuapi/target/jnifmuapi-*-SNAPSHOT.jar
            fmi2/target/fmi2-*-SNAPSHOT.jar
          retention-days: 5

